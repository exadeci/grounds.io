image:
  build: .

web:
  image: groundsio_image
  command: rake run
  ports:
    - '3000:3000'
  links:
    - redis
    - db
  volumes:
    - .:/grounds
  environment:
    - RAILS_ENV
    - DOCKER_URL
    - SECRET_KEY_BASE
    - NEWRELIC_LICENSE_KEY
    - NEWRELIC_APP_NAME
    - DB_USERNAME=docker
    - DB_PASSWORD=docker
    - SORCERY_GITHUB_KEY=
    - SORCERY_GITHUB_SECRET=

test:
  image: groundsio_image
  command: rake test
  links:
    - db
    - runner
  environment:
    - TEST_OPTS
    - DOCKER_URL
    - DB_USERNAME=docker
    - DB_PASSWORD=docker

redis:
  image: dockerfile/redis
  expose:
    - '6379'
  volumes:
    - /redis:/data

db:
  image: orchardup/postgresql
  expose:
    - '5432'

runner:
  image: grounds/grounds-exec
  command: hack/server.sh
  ports:
    - '8080:8080'
  volumes:
    - $DOCKER_CERT_PATH:/home/.docker
  environment:
    - DOCKER_URL
    - REPOSITORY
